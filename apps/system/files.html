<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>Untitled Document</title>
<script>eval(top.frames['idesktop'].setAppProperties());</script>
<style>
#folders {
	position:relative;
	display:inline;
	width:25%;
	overflow:scroll;
	height: 100%;
}

#files {
	position:relative;
	display:inline;
	width:75%;
	overflow:scroll;
}
</style>
<script>
var strFiles = new Array;
var strFoldersList = new Array;
var notPSP = (navigator.userAgent.indexOf('PlayStation Portable') != -1) ? false : true;

var strExt = new Array();
var strExtApp = new Array();
var strExtType = new Array();
var strExtAppURL = new Array();
var strExtIconURL = new Array();

function unload(){
	if(confirm("Are you sure you wish to quit?")) parent.killApp();
}

function getFileExtensionList() {
	var strSettings;
	
	if (parent!==self){
		if (notPSP){
			var cookiedata = unescape(parent.window.document.cookie);
			var cookiecontents = cookiedata.split("=");
			if(cookiecontents[0] == "cookiedata") {
				strSettings = cookiecontents[1].split("»");
			}else strSettings = "";
		}else
			strSettings = window.top.isettings.document.getElementById("settingList").value.split("»");	// Split up the settings
	}
	
	for ( var i = 0 ; i < strSettings.length ; i++ ) {
		var strApps = strSettings[i].split("¿");
		if(strApps[0]=='fileExt'){
			var strSettingParts = strApps[1].split("º");
			var strExtParts = strSettingParts[1].split("^");;
			
			strExtApp[strExt.length] = strExtParts[0];
			strExtType[strExt.length] = strExtParts[1];
			strExtAppURL[strExt.length] = strExtParts[2];
			strExtIconURL[strExt.length] = strExtParts[3];
			strExt[strExt.length] = strSettingParts[0];
		}
	}
			
}

function getFileList() {
	if (parent!==self){
		if (notPSP){
			var cookiedata = unescape(parent.window.document.cookie);
			var cookiecontents = cookiedata.split("=");
			if(cookiecontents[0] == "cookiedata") {
				strFiles = cookiecontents[1].split("»");
			}else strFiles = "";
		}else
			strFiles = window.top.ifiles.document.getElementById("fileList").value.split("»");	// Split up the files
	} else alert("Program not functional in this mode.");
}

function makeFolderList(){
	for (var i = 0 ; i < strFiles.length ; i++ ) {
		var strFileParts = strFiles[i].split("¿");			// Split key from value
		var strFileExist = false;
		for (var i2 = 0 ; i2 < strFoldersList.length ; i2++){
			if ( strFoldersList[i2] == strFileParts[0]){
				strFileExist=true;
				break;
			}
		}
		
		if (!strFileExist){
			strFoldersList[strFoldersList.length] = strFileParts[0];
			frames['folders'].document.write("<a href='javascript:;' onclick='parent.makeFileList(\""+strFileParts[0]+"\")'>"+strFileParts[0]+"</a><br>");
		}
	}
}


function makeFileList(strFolder){
	frames['files'].document.open();
	// The following code is crap, but required. It is very bad practice, as it uses up resources to gain time.
	// This code is very bad practive, and should rarely be used, if ever.
	
	// BEGIN CRAP CODE
	for(var i = 0; i<90;i++) {	
		frames['files'].document.write("<script>var a = 300*2;</"+"script>");
	}
	// END CRAP CODE
	
	frames['files'].document.write("<head><script>eval(top.frames['idesktop'].setAppProperties());<"+"/script></head>");

	// BEGIN CRAP CODE
	for(var i = 0; i<50;i++) {	
		frames['files'].document.write("<script>var a = 300*2;</"+"script>");
	}
	// END CRAP CODE
	
	frames['files'].document.write("<body><table border='0' width='100%' cellspacing='0'><tr><th class='listHead'>Name</th><th class='listHead'>Size</th><th class='listHead'>Type</th></th><th class='listHead'>&nbsp;</tr>");
	for (var i = 0 ; i < strFiles.length ; i++ ) {
		var strFileParts = strFiles[i].split("¿");			// Split key from value
		if (strFileParts[0]==strFolder){
			var strParts = strFileParts[1].split("º");
			var strFileNameParts = strParts[0].split(".");
			
			for(var i2 = 0 ; i2 < strExt.length ; i2++ ) {
				if ( strFileNameParts[strFileNameParts.length-1]==strExt[i2]){
					var strAppURL = strExtAppURL[i2]+'?folder='+strFolder+'&file='+strParts[0];
					var strIconURL = strExtIconURL[i2];
					var strType = strExtType[i2];
				}
			}

			frames['files'].document.write("<tr><td><a href='javascript:;' onclick='top.frames[\"idesktop\"].loadApp(\"Test\",\""+strAppURL+"\",\"\");'><img height='14' width='14' src='" + top.encoreUrl + "theme/default/" + strIconURL + "' />"+strParts[0]+"</a></td>");
			
			frames['files'].document.write("<td>"+(Math.round(((strFolder.length*8)+(parent.getFile(strFolder,strParts[0],'').length*8)+24)/10.24)/100)+" KB</td>");
			
			frames['files'].document.write("<td>"+strType+"</td>");
			
			frames['files'].document.write("<td width='30'><input value='Delete' type='button' onclick='' /></td></tr>");
		}
	}
	frames['files'].document.write("</table></body>");
	frames['files'].document.close();
}

getFileList();
getFileExtensionList();
</script>
</head>

<body>
<table height="100%" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
  <td colspan="3" height="20" style="font-size:12px;"><a href="javascript:;" onclick="parent.clearFiles();">Clear all files</a></td>
  </tr>
<tr><td width="110">
<iframe id="folders" style="width:100%;" src="../../system/blank.htm" name="folders"></iframe>
</td>
<td width="2">&nbsp;</td>
<td>
<iframe id="files" style="width:100%;" src="../../system/blank.htm" name="files"></iframe></td>
</tr></table>
<script language="javascript" type="text/javascript">
var intEffectiveHeight = document.body.clientHeight-22;

document.getElementById('folders').style.height=intEffectiveHeight;
document.getElementById('files').style.height=intEffectiveHeight;


function writeFiles(){
	frames['folders'].document.open();
	frames['folders'].document.write("<style>body{margin:0px;}</style>");
	makeFolderList();
	frames['folders'].document.close();
	
	frames['files'].document.open();
	makeFileList('main');
	frames['files'].document.close();
}

setTimeout("writeFiles('testfolder');",2500);
</script>
</body>
</html>
